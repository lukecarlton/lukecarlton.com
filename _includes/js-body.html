<script type="text/javascript">
    /**
     * Picture element HTML5 shiv
     */
    document.createElement('picture');
    // Picturefill (minified)
    window.matchMedia||(window.matchMedia=function(){"use strict";var a=window.styleMedia||window.media;if(!a){var b=document.createElement("style"),c=document.getElementsByTagName("script")[0],d=null;b.type="text/css",b.id="matchmediajs-test",c.parentNode.insertBefore(b,c),d="getComputedStyle"in window&&window.getComputedStyle(b,null)||b.currentStyle,a={matchMedium:function(a){var c="@media "+a+"{ #matchmediajs-test { width: 1px; } }";return b.styleSheet?b.styleSheet.cssText=c:b.textContent=c,"1px"===d.width}}}return function(b){return{matches:a.matchMedium(b||"all"),media:b||"all"}}}()),function(a,b){"use strict";function c(a){var b,c,d,f,g,h=a||{};b=h.elements||e.getAllElements();for(var i=0,j=b.length;j>i;i++)if(c=b[i],d=c.parentNode,f=void 0,g=void 0,c[e.ns]||(c[e.ns]={}),h.reevaluate||!c[e.ns].evaluated){if("PICTURE"===d.nodeName.toUpperCase()){if(e.removeVideoShim(d),f=e.getMatch(c,d),f===!1)continue}else f=void 0;("PICTURE"===d.nodeName.toUpperCase()||c.srcset&&!e.srcsetSupported||!e.sizesSupported&&c.srcset&&c.srcset.indexOf("w")>-1)&&e.dodgeSrcset(c),f?(g=e.processSourceSet(f),e.applyBestCandidate(g,c)):(g=e.processSourceSet(c),(void 0===c.srcset||c[e.ns].srcset)&&e.applyBestCandidate(g,c)),c[e.ns].evaluated=!0}}function d(){c();var d=setInterval(function(){return c(),/^loaded|^i|^c/.test(b.readyState)?void clearInterval(d):void 0},250);if(a.addEventListener){var e;a.addEventListener("resize",function(){a._picturefillWorking||(a._picturefillWorking=!0,a.clearTimeout(e),e=a.setTimeout(function(){c({reevaluate:!0}),a._picturefillWorking=!1},60))},!1)}}if(a.HTMLPictureElement)return void(a.picturefill=function(){});b.createElement("picture");var e={};e.ns="picturefill",e.srcsetSupported="srcset"in b.createElement("img"),e.sizesSupported=a.HTMLImageElement.sizes,e.trim=function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},e.endsWith=function(a,b){return a.endsWith?a.endsWith(b):-1!==a.indexOf(b,a.length-b.length)},e.matchesMedia=function(b){return a.matchMedia&&a.matchMedia(b).matches},e.getDpr=function(){return a.devicePixelRatio||1},e.getWidthFromLength=function(a){return a=a&&(parseFloat(a)>0||a.indexOf("calc(")>-1)?a:"100vw",a=a.replace("vw","%"),e.lengthEl||(e.lengthEl=b.createElement("div"),b.documentElement.insertBefore(e.lengthEl,b.documentElement.firstChild)),e.lengthEl.style.cssText="position: absolute; left: 0; width: "+a+";",e.lengthEl.offsetWidth<=0&&(e.lengthEl.style.cssText="width: 100%;"),e.lengthEl.offsetWidth},e.types={},e.types["image/jpeg"]=!0,e.types["image/gif"]=!0,e.types["image/png"]=!0,e.types["image/svg+xml"]=b.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1"),e.types["image/webp"]=function(){var b=new a.Image,d="image/webp";b.onerror=function(){e.types[d]=!1,c()},b.onload=function(){e.types[d]=1===b.width,c()},b.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA="},e.verifyTypeSupport=function(a){var b=a.getAttribute("type");return null===b||""===b?!0:"function"==typeof e.types[b]?(e.types[b](),"pending"):e.types[b]},e.parseSize=function(a){var b=/(\([^)]+\))?\s*(.+)/g.exec(a);return{media:b&&b[1],length:b&&b[2]}},e.findWidthFromSourceSize=function(a){for(var b,c=e.trim(a).split(/\s*,\s*/),d=0,f=c.length;f>d;d++){var g=c[d],h=e.parseSize(g),i=h.length,j=h.media;if(i&&(!j||e.matchesMedia(j))){b=i;break}}return e.getWidthFromLength(b)},e.parseSrcset=function(a){for(var b=[];""!==a;){a=a.replace(/^\s+/g,"");var c,d=a.search(/\s/g),e=null;if(-1!==d){c=a.slice(0,d);var f=c[c.length-1];if((","===f||""===c)&&(c=c.replace(/,+$/,""),e=""),a=a.slice(d+1),null===e){var g=a.indexOf(",");-1!==g?(e=a.slice(0,g),a=a.slice(g+1)):(e=a,a="")}}else c=a,a="";(c||e)&&b.push({url:c,descriptor:e})}return b},e.parseDescriptor=function(a,b){var c,d=b||"100vw",f=a&&a.replace(/(^\s+|\s+$)/g,""),g=e.findWidthFromSourceSize(d);if(f)for(var h=f.split(" "),i=h.length+1;i>=0;i--)if(void 0!==h[i]){var j=h[i],k=j&&j.slice(j.length-1);if("h"!==k&&"w"!==k||e.sizesSupported){if("x"===k){var l=j&&parseFloat(j,10);c=l&&!isNaN(l)?l:1}}else c=parseFloat(parseInt(j,10)/g)}return c||1},e.getCandidatesFromSourceSet=function(a,b){for(var c=e.parseSrcset(a),d=[],f=0,g=c.length;g>f;f++){var h=c[f];d.push({url:h.url,resolution:e.parseDescriptor(h.descriptor,b)})}return d},e.dodgeSrcset=function(a){a.srcset&&(a[e.ns].srcset=a.srcset,a.removeAttribute("srcset"))},e.processSourceSet=function(a){var b=a.getAttribute("srcset"),c=a.getAttribute("sizes"),d=[];return"IMG"===a.nodeName.toUpperCase()&&a[e.ns]&&a[e.ns].srcset&&(b=a[e.ns].srcset),b&&(d=e.getCandidatesFromSourceSet(b,c)),d},e.applyBestCandidate=function(a,b){var c,d,f;a.sort(e.ascendingSort),d=a.length,f=a[d-1];for(var g=0;d>g;g++)if(c=a[g],c.resolution>=e.getDpr()){f=c;break}f&&!e.endsWith(b.src,f.url)&&(b.src=f.url,b.currentSrc=b.src)},e.ascendingSort=function(a,b){return a.resolution-b.resolution},e.removeVideoShim=function(a){var b=a.getElementsByTagName("video");if(b.length){for(var c=b[0],d=c.getElementsByTagName("source");d.length;)a.insertBefore(d[0],c);c.parentNode.removeChild(c)}},e.getAllElements=function(){for(var a=[],c=b.getElementsByTagName("img"),d=0,f=c.length;f>d;d++){var g=c[d];("PICTURE"===g.parentNode.nodeName.toUpperCase()||null!==g.getAttribute("srcset")||g[e.ns]&&null!==g[e.ns].srcset)&&a.push(g)}return a},e.getMatch=function(a,b){for(var c,d=b.childNodes,f=0,g=d.length;g>f;f++){var h=d[f];if(1===h.nodeType){if(h===a)return c;if("SOURCE"===h.nodeName.toUpperCase()){null!==h.getAttribute("src")&&void 0!==typeof console&&console.warn("The `src` attribute is invalid on `picture` `source` element; instead, use `srcset`.");var i=h.getAttribute("media");if(h.getAttribute("srcset")&&(!i||e.matchesMedia(i))){var j=e.verifyTypeSupport(h);if(j===!0){c=h;break}if("pending"===j)return!1}}}}return c},d(),c._=e,"object"==typeof module&&"object"==typeof module.exports?module.exports=c:"function"==typeof define&&define.amd?define(function(){return c}):"object"==typeof a&&(a.picturefill=c)}(this,this.document);

    {% if page.category %}
        /**
         * Smart Window Resize
         */
        (function($,sr){
            // debouncing function from John Hann
            // http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
            var debounce = function (func, threshold, execAsap) {
                var timeout;
                return function debounced () {
                    var obj = this, args = arguments;
                    function delayed () {
                        if (!execAsap)
                            func.apply(obj, args);
                        timeout = null;
                    };
                    if (timeout)
                        clearTimeout(timeout);
                    else if (execAsap)
                        func.apply(obj, args);
                    timeout = setTimeout(delayed, threshold || 100);
                };
            }
            // smartresize
            jQuery.fn[sr] = function(fn){  return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr); };
        })(jQuery,'smartresize');

        /**
         * Fix Navigation Clicks
         */
        $('.secondary-navigation-list a').click( function() {
            $('.secondary-navigation-toggler').removeAttr('checked');
            $('#secondary-navigation-toggler-cancel').attr('checked', 'checked');
        });
        $('.primary-navigation-list label, label[for="secondary-navigation-toggler-cancel"]').click( function() {
            setTimeout( function() {
                moveNavigation();
            }, 101);
        });

        /**
         * Carousel Functionality
         */
        $('.item-navigation, .item-scrubber').hide();
        var activeItem,
            numItems          = $('.item-carousel > li').length,
            carouselWidth     = numItems * 100,
            carouselOffset    = 0,
            newCarouselOffset = 0,
            navigationOffset  = 0,
            scrubberOffset    = 0,
            activeScrubber    = 0,
            currentURL,
            newSlug,
            newURL;
        function moveNavigation() {
            navigationOffset = $('.item-carousel > .active .item-media').outerHeight(true) - 10 + 'px';
            $('.item-navigation').css('top', navigationOffset);
        }
        function moveScrubber() {
            scrubberOffset = $('.item-carousel > .active .item-media').outerHeight(true) + $('.item-carousel > .active .item-content').innerHeight() - 56 + 'px';
            $('.item-scrubber').css('top', scrubberOffset);
        }
        function changeSlug() {
            currentURL = (document.URL).replace(/\/$/, '');
            newSlug = $('.item-carousel .active').attr('data-slug');
            newURL = currentURL.substring(0, (currentURL.lastIndexOf("/") + 1)) + newSlug;
            window.history.replaceState("", "", newURL);
        }
        $(window).load( function() {
            moveScrubber();
            moveNavigation();
            $('.item-navigation, .item-scrubber').show();
        });
        $(window).smartresize( function() {
            moveScrubber();
            moveNavigation();
        });
        function scrollNew() {
            carouselOffset = $('.item-carousel').get(0).style.marginLeft.replace('%','');
            activeItem = $('.item-carousel > .active');
        }
        function scrollPrevious() {
            activeItem.removeClass('active');
            if( activeItem.is(':first-child') ) {
                $('.item-carousel > li:last-child').addClass('active');
                activeScrubber = $('.item-carousel > li:last-child').index();
            } else {
                activeItem.prev().addClass('active');
                activeScrubber = activeItem.prev().index();
            }
            newCarouselOffset = parseInt(carouselOffset) + 100;
            if( newCarouselOffset > 0 ) {
                newCarouselOffset = ((numItems - 1) * 100 * -1);
            }
            $('.item-carousel').css('margin-left', newCarouselOffset + '%');
        }
        function scrollNext() {
            activeItem.removeClass('active');
            if( activeItem.is(':last-child') ) {
                $('.item-carousel > li:first-child').addClass('active');
                activeScrubber = 0;
            } else {
                activeItem.next().addClass('active');
                activeScrubber = activeItem.next().index();
            }
            newCarouselOffset = parseInt(carouselOffset) - 100;
            if( newCarouselOffset <= (numItems * 100 * -1) ) {
                newCarouselOffset = 0;
            }
            $('.item-carousel').css('margin-left', newCarouselOffset + '%');
        }
        function scrollReset() {
            // Reset the active scrubber item
            $('.item-scrubber .active').removeClass('active');
            $('.item-scrubber li').eq(activeScrubber).addClass('active');
            moveScrubber();
            moveNavigation();
            changeSlug();
        }
        $('.item-navigation a').click( function(e) {
            e.preventDefault();
            scrollNew();
            if( $(this).parent().hasClass('item-previous') ) {
                scrollPrevious();
            }
            if( $(this).parent().hasClass('item-next') ) {
                scrollNext();
            }
            scrollReset();
        });
        $('body').keydown( function(e) {
            scrollNew();
            if( e.which == 37 ) {
                scrollPrevious();
            } else if ( e.which == 39 ) {
                scrollNext();
            }
            scrollReset();
        });
        $('.item-scrubber a').click( function(e) {
            e.preventDefault();
            activeScrubber = $(this).parent().index();
            // Reset the active scrubber item
            $('.item-scrubber .active').removeClass('active');
            $(this).parent().addClass('active');
            // Slide the carousel based on the new active item
            $('.item-carousel').css('margin-left', (activeScrubber * 100 * -1) + '%');
            moveScrubber();
            moveNavigation();
            changeSlug();
        });
    {% endif %}
</script>
